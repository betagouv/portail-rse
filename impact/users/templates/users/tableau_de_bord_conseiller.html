{% extends "base.html" %}
{% load static %}

{% block title %}Espace Conseiller RSE - Portail RSE{% endblock %}

{% block content %}
    <div class="fr-container fr-my-4w">
        <!-- Section 1 : En-tête avec navigation -->
        <div class="fr-grid-row fr-mb-4w">
            <div class="fr-col-12">
                <h1>Espace Conseiller RSE</h1>
                <p class="fr-text--lead">
                    Gérez vos missions d'accompagnement RSE depuis cet espace dédié.
                </p>
            </div>
        </div>


        <!-- Section 2 : Tuiles d'accès rapide (placeholders) -->
        <div class="fr-grid-row fr-grid-row--gutters fr-mb-6w">
            <div class="fr-col-12">
                <h2>Accès rapide</h2>
            </div>
            <div class="fr-col-12 fr-col-md-4">
                <div class="fr-tile fr-enlarge-link">
                    <div class="fr-tile__body">
                        <div class="fr-tile__content">
                            <h3 class="fr-tile__title">
                                <a href="#">Placeholder 1</a>
                            </h3>
                            <p class="fr-tile__desc">Description à définir</p>
                        </div>
                    </div>
                    <div class="fr-tile__header">
                        <div class="fr-card__img">
                            <img class="fr-responsive-img fr-ratio-3x2" src="{% static 'img/dashboard.png' %}" alt="" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="fr-col-12 fr-col-md-4">
                <div class="fr-tile fr-enlarge-link">
                    <div class="fr-tile__body">
                        <div class="fr-tile__content">
                            <h3 class="fr-tile__title">
                                <a href="#">Placeholder 2</a>
                            </h3>
                            <p class="fr-tile__desc">Description à définir</p>
                        </div>
                    </div>
                    <div class="fr-tile__header">
                        <div class="fr-card__img">
                            <img class="fr-responsive-img fr-ratio-3x2" src="{% static 'img/simulation.png' %}" alt="" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="fr-col-12 fr-col-md-4">
                <div class="fr-tile fr-enlarge-link">
                    <div class="fr-tile__body">
                        <div class="fr-tile__content">
                            <h3 class="fr-tile__title">
                                <a href="#">Placeholder 3</a>
                            </h3>
                            <p class="fr-tile__desc">Description à définir</p>
                        </div>
                    </div>
                    <div class="fr-tile__header">
                        <div class="fr-card__img">
                            <img class="fr-responsive-img fr-ratio-3x2" src="{% static 'img/piloter.png' %}" alt="" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3 : Résumé des entreprises en gestion -->
        <div class="fr-grid-row fr-mb-6w">
            <div class="fr-col-12">
                <h2>Mes entreprises en gestion</h2>
                {% if habilitations_enrichies %}
                    <div class="fr-table--sm fr-table fr-table">
                        <div class="fr-table__wrapper">
                            <div class="fr-table__container">
                                <div class="fr-table__content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th scope="col">Dénomination</th>
                                                <th scope="col">SIREN</th>
                                                <th scope="col">Statut</th>
                                                <th scope="col">Informations</th>
                                                <th scope="col">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in habilitations_enrichies %}
                                                <tr>
                                                    <td>{{ item.entreprise.denomination }}</td>
                                                    <td>{{ item.entreprise.siren }}</td>
                                                    <td>
                                                        {% if item.entreprise.est_structure_vacante %}
                                                            <span class="fr-badge fr-badge--warning fr-badge--no-icon">Sans propriétaire</span>
                                                        {% else %}
                                                            <span class="fr-badge fr-badge--success fr-badge--no-icon">Active</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <ul class="fr-raw-list fr-text--sm">
                                                            {% with pluriel=item.nombre_reglementations|pluralize %}
                                                                <li>
                                                                    Réglementation{{ pluriel }} applicable{{ pluriel }}&nbsp;: <strong>{{ item.nombre_reglementations }}</strong>
                                                                </li>
                                                            {% endwith %}
                                                            <li>
                                                                Progression VSME&nbsp;: <strong>{{ item.pourcentage_vsme }}%</strong>
                                                            </li>
                                                        </ul>
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'reglementations:tableau_de_bord' item.entreprise.siren %}" class="fr-btn fr-btn--sm fr-icon-arrow-right-line fr-btn--icon-right">
                                                            Accéder au tableau de bord
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="fr-callout fr-icon-information-line">
                        <p class="fr-callout__text">
                            Vous n'êtes rattaché à aucune entreprise pour le moment.
                            Utilisez le formulaire ci-dessous pour ajouter une entreprise en gestion.
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Section 4 : Formulaire unifié d'ajout d'entreprise -->
        <div class="fr-grid-row">
            <div class="fr-col-12 fr-col-md-8">
                <h2>Ajouter une entreprise en gestion</h2>
                <p>Recherchez une entreprise par son SIREN pour vous y rattacher.</p>

                <form method="post" action="{% url 'users:tableau_de_bord_conseiller' %}">
                    {% csrf_token %}

                    {% include 'users/fragments/siren_field_conseiller.html' %}

                    <!-- Zone dynamique HTMX pour le statut de l'entreprise -->
                    <div id="statut-entreprise-container" class="fr-mt-2w">
                        {% if statut %}
                            {% include 'users/fragments/statut_entreprise.html' %}
                        {% endif %}
                    </div>

                    <div id="champ-fonctions">
                        {% include 'snippets/field.html' with field=form.fonctions %}
                    </div>

                    <button type="submit" class="fr-btn fr-mt-2w" id="btn-ajouter-entreprise">
                        Ajouter l'entreprise
                    </button>
                </form>

                <div class="fr-callout fr-callout--info fr-icon-information-line fr-mt-4w">
                    <p class="fr-callout__text">
                        <strong>Fonctionnement :</strong>
                    </p>
                    <ul>
                        <li>Si l'entreprise existe et a un propriétaire : vous serez rattaché comme "Editeur"</li>
                        <li>Si l'entreprise existe sans propriétaire : vous devrez indiquer l'e-mail du futur propriétaire</li>
                        <li>Si l'entreprise n'existe pas : elle sera créée et vous devrez indiquer l'e-mail du futur propriétaire</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Réinitialiser le statut quand le champ de recherche est vidé
    // Utilise la délégation d'événements pour fonctionner après les swaps HTMX
        document.addEventListener('input', function(event) {
            if (event.target && event.target.id === 'id_recherche') {
                if (event.target.value.trim() === '') {
                // Appeler le préremplissage avec des valeurs vides pour réinitialiser
                    htmx.ajax('GET', '{% url "users:preremplissage_siren_conseiller" %}?siren=&denomination=', {
                        target: '#htmx-preremplissage-target',
                        swap: 'outerHTML'
                    });
                }
            }
        });
    </script>
{% endblock %}
