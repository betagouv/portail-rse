# Configuration nginx minimale avec filtrage IP
server {
    listen <%= ENV["PORT"] %>;

    # Filtrage IP dynamique depuis BLOCKED_IP_SUBNETS
<% if ENV['BLOCKED_IP_SUBNETS'] && !ENV['BLOCKED_IP_SUBNETS'].empty? %>
<% ENV['BLOCKED_IP_SUBNETS'].split(',').each do |subnet| %>
    deny <%= subnet.strip %>;
<% end %>
<% end %>
    allow all;

    client_max_body_size 100M;

    # Proxy vers l'application Django via socket Unix
    location / {
        proxy_pass http://unix:/tmp/gunicorn.sock;
        proxy_redirect off;

        # Headers pour proxy
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Forcer HTTPS car Scalingo termine toujours le TLS
        proxy_set_header X-Forwarded-Proto https;

        # Timeouts
        proxy_connect_timeout 90s;
        proxy_send_timeout 90s;
        proxy_read_timeout 90s;
    }
}
